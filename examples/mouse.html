<meta http-equiv="content-type" charset="utf-8">
<canvas id="demo"></canvas>
<script src="../overprint.js"></script>
<script>
var canvas = document.getElementById("demo");
canvas.style.width = document.documentElement.clientWidth;
canvas.style.height = document.documentElement.clientHeight;
canvas.style.margin = '0px';
canvas.style.padding = '0px';
document.body.style.margin = '0px';
document.body.style.padding = '0px';

var grid = new overprint.TextGrid(canvas, { width: 40, height: 20});

var activeCell = {x: Infinity, y: Infinity }
var lineBuffer = null;

var MarkedCell = overprint.Cell("â€¢", "#000", "#f00");
var BlankCell = overprint.Cell(overprint.Char.NULL, "#000", "#fff");
var CursorCell = overprint.Cell(overprint.Char.NULL, "#fff", "#000");

grid.onClick(function(col, row) {
  if (!lineBuffer) {
    grid.clear()
    lineBuffer = {x: col, y: row};
    grid.writeCell(col, row, MarkedCell);
  } else {
    var path = line(lineBuffer, {x: col, y: row});

    for (point of path) {
      grid.writeCell(point.x, point.y, MarkedCell);
    }

    lineBuffer = null;
  }

  grid.render();
})

grid.onMouseMove(function(col, row) {
  if (lineBuffer) {
    grid.clear()

    var path = line(lineBuffer, {x: col, y: row});

    for (point of path) {
      grid.writeCell(point.x, point.y, MarkedCell);
    }
  } else {
    if (!grid.readCell(row, col) === MarkedCell) {
      grid.writeCell(activeCell.x, activeCell.y, CursorCell);
      activeCell.x = col
      activeCell.y = row
    }
  }
  grid.render();
});

function line(from, to) {
  let { x: x0, y: y0 } = from;
  let { x: x1, y: y1 } = to;

  const dx = Math.abs(x1 - x0);
  const dy = Math.abs(y1 - y0);

  const sx = x0 < x1 ? 1 : -1;
	const sy = y0 < y1 ? 1 : -1;

  let err = dx - dy;

  const points = [];

  while(true) {
    points.push({x: x0, y: y0});

    if (x0 == x1 && y0 == y1) break;

    const errq = err * 2;

    if (errq > -dx) {
      err -= dy;
      x0 += sx;
    }

    if (errq < dx) {
      err += dx;
      y0 += sy;
    }
  }

  return points;
}

grid.render();

</script>
